name: updpkgsums

on:
  pull_request:
    types:
      - opened
      - synchronize
    branches:
      - main

jobs:
  find-packages:
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.find_pkgbuilds.outputs.packages }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Find updated packages
        id: find_pkgbuilds
        run: |
          #!/usr/bin/env bash
          set -euxo pipefail

          # Get all modified PKGBUILDs and their directories
          pkgbuilds=$(git diff --name-only origin/main origin/${GITHUB_HEAD_REF} "*PKGBUILD" | xargs -I {} dirname {} | sort -u)

          # Convert to JSON array for matrix
          if [ -n "$pkgbuilds" ]; then
            echo "packages=$(echo "$pkgbuilds" | jq -R . | jq -sc .)" >> $GITHUB_OUTPUT
          else
            echo "packages=[]" >> $GITHUB_OUTPUT
          fi

  updpkgsums:
    needs: find-packages
    if: ${{ fromJSON(needs.find-packages.outputs.packages)[0] != null }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package: ${{ fromJSON(needs.find-packages.outputs.packages) }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Validate package
        uses: ./.github/actions/aur
        with:
          action: "updpkgsums"
          pkgname: ${{ matrix.package }}

      - name: Commit
        uses: stefanzweifel/git-auto-commit-action@28e16e81777b558cc906c8750092100bbb34c5e3 # v7
        with:
          file_pattern: "*/PKGBUILD */.SRCINFO"
