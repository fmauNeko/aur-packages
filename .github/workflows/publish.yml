name: publish

on:
  push:
    branches:
      - main
    paths:
      - "*/PKGBUILD"

jobs:
  find-packages:
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.find_pkgbuilds.outputs.packages }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0

      - name: Find updated packages
        id: find_pkgbuilds
        run: |
          #!/usr/bin/env bash
          set -euxo pipefail

          # Get all modified .SRCINFO files and their directories
          pkgbuilds=$(git diff --name-only HEAD HEAD~1 "*/.SRCINFO" | xargs -I {} dirname {} | sort -u)

          # Convert to JSON array for matrix
          if [ -n "$pkgbuilds" ]; then
            echo "packages=$(echo "$pkgbuilds" | jq -R . | jq -sc .)" >> $GITHUB_OUTPUT
          else
            echo "packages=[]" >> $GITHUB_OUTPUT
          fi

  publish:
    needs: find-packages
    if: ${{ fromJSON(needs.find-packages.outputs.packages)[0] != null }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package: ${{ fromJSON(needs.find-packages.outputs.packages) }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0

      - name: Extract local assets from PKGBUILD
        id: extract_assets
        run: |
          #!/usr/bin/env bash
          set -euo pipefail

          cd "${{ matrix.package }}"

          # Source the PKGBUILD to extract source arrays
          source PKGBUILD

          # Collect all source entries
          all_sources=("${source[@]}")

          # Add architecture-specific sources if they exist
          for arch in "${arch[@]}"; do
            var_name="source_${arch}[@]"
            if [[ -v $var_name ]]; then
              all_sources+=("${!var_name}")
            fi
          done

          # Filter for local files (not URLs)
          local_files=()
          for src in "${all_sources[@]}"; do
            # Extract filename from "name::url" syntax
            file="${src##*::}"
            # Skip URLs (http://, https://, ftp://, etc.)
            if [[ ! "$file" =~ ^[a-zA-Z][a-zA-Z0-9+.-]*:// ]]; then
              # Check if file exists in package directory
              if [[ -f "$file" ]]; then
                local_files+=("$file")
              fi
            fi
          done

          # Generate .gitignore file
          cat > .gitignore << 'GITIGNORE_EOF'
          *
          !PKGBUILD
          !.SRCINFO
          GITIGNORE_EOF

          for file in "${local_files[@]}"; do
            echo "!$file" >> .gitignore
          done

          # Convert to newline-delimited list for assets parameter with package path prefix
          echo "assets<<EOF" >> $GITHUB_OUTPUT
          echo "${{ matrix.package }}/.gitignore" >> $GITHUB_OUTPUT
          if [ ${#local_files[@]} -gt 0 ]; then
            for file in "${local_files[@]}"; do
              echo "${{ matrix.package }}/$file" >> $GITHUB_OUTPUT
            done
          fi
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Publish package
        uses: KSXGitHub/github-actions-deploy-aur@2ac5a4c1d7035885d46b10e3193393be8460b6f1 # v4.1.1
        with:
          pkgname: ${{ matrix.package }}
          pkgbuild: ${{ matrix.package }}/PKGBUILD
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          assets: ${{ steps.extract_assets.outputs.assets }}
